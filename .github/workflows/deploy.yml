# ============================================================================
# Infrastructure Deployment Workflow
# ============================================================================
# Deploys Azure infrastructure using Bicep templates.
#
# Triggers:
# - Manual dispatch (workflow_dispatch) with environment selection
# - Push to main branch (deploys to dev)
#
# Authentication:
# Uses OIDC (Workload Identity Federation) - no secrets stored in GitHub!
# You need to set up an Azure AD App Registration with federated credentials.
#
# Required GitHub Secrets:
# - AZURE_CLIENT_ID: App registration client ID
# - AZURE_TENANT_ID: Azure AD tenant ID
# - AZURE_SUBSCRIPTION_ID: Azure subscription ID
# - SQL_ADMIN_LOGIN: SQL Server admin username
# - SQL_ADMIN_PASSWORD: SQL Server admin password
# - SECRET_KEY: JWT secret key for authentication
# ============================================================================

name: Deploy Infrastructure

on:
  # Manual trigger with environment selection
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      skip_what_if:
        description: 'Skip what-if preview (deploy immediately)'
        required: false
        default: false
        type: boolean

  # Auto-deploy dev on push to main
  push:
    branches: [main]
    paths:
      - 'infra/**'

# Permissions required for OIDC authentication
permissions:
  id-token: write   # Required for OIDC
  contents: read    # Required to checkout code

# Prevent concurrent deployments to the same environment
concurrency:
  group: deploy-${{ github.event.inputs.environment || 'dev' }}
  cancel-in-progress: false

env:
  # Default to 'dev' for push events, use input for manual triggers
  ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}

jobs:
  # --------------------------------------------------------------------------
  # Job 1: Validate templates before deployment
  # --------------------------------------------------------------------------
  validate:
    name: Validate Templates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Bicep
        run: az bicep build --file infra/main.bicep

  # --------------------------------------------------------------------------
  # Job 2: What-If Preview (shows what will change)
  # --------------------------------------------------------------------------
  what-if:
    name: Preview Changes
    runs-on: ubuntu-latest
    needs: validate
    # Skip if explicitly requested
    if: ${{ github.event.inputs.skip_what_if != 'true' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # OIDC authentication to Azure
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Ensure resource group exists
      - name: Create Resource Group (if needed)
        run: |
          az group create \
            --name "newsmind-${{ env.ENVIRONMENT }}-rg" \
            --location "eastus2" \
            --tags Environment=${{ env.ENVIRONMENT }} Project=NewsMinds

      # What-If shows what would change without actually changing anything
      - name: What-If Preview
        env:
          SQL_LOGIN: ${{ secrets.SQL_ADMIN_LOGIN }}
          SQL_PASSWORD: ${{ secrets.SQL_ADMIN_PASSWORD }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "üîç Previewing changes for ${{ env.ENVIRONMENT }} environment..."
          echo ""

          az deployment group what-if \
            --resource-group "newsmind-${{ env.ENVIRONMENT }}-rg" \
            --template-file infra/main.bicep \
            --parameters infra/environments/${{ env.ENVIRONMENT }}.bicepparam \
            --parameters sqlAdminLogin="$SQL_LOGIN" \
            --parameters sqlAdminPassword="$SQL_PASSWORD" \
            --parameters secretKey="$SECRET_KEY" \
            --parameters openaiApiKey="$OPENAI_API_KEY"


  # --------------------------------------------------------------------------
  # Job 3: Deploy Infrastructure
  # --------------------------------------------------------------------------
  deploy:
    name: Deploy to ${{ github.event.inputs.environment || 'dev' }}
    runs-on: ubuntu-latest
    needs: [validate, what-if]
    # Always run after validate, what-if may be skipped
    if: ${{ always() && needs.validate.result == 'success' && (needs.what-if.result == 'success' || needs.what-if.result == 'skipped') }}

    # Environment protection rules (optional - configure in GitHub settings)
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}
      url: ${{ steps.deploy.outputs.api_url }}

    outputs:
      api_url: ${{ steps.deploy.outputs.api_url }}
      keyvault_name: ${{ steps.deploy.outputs.keyvault_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create Resource Group
        run: |
          az group create \
            --name "newsmind-${{ env.ENVIRONMENT }}-rg" \
            --location "eastus2" \
            --tags Environment=${{ env.ENVIRONMENT }} Project=NewsMinds ManagedBy=GitHubActions

      - name: Deploy Infrastructure
        id: deploy
        env:
          SQL_LOGIN: ${{ secrets.SQL_ADMIN_LOGIN }}
          SQL_PASSWORD: ${{ secrets.SQL_ADMIN_PASSWORD }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "üöÄ Deploying to ${{ env.ENVIRONMENT }}..."
          echo ""

          # Deploy with Bicep
          deployment_output=$(az deployment group create \
            --resource-group "newsmind-${{ env.ENVIRONMENT }}-rg" \
            --template-file infra/main.bicep \
            --parameters infra/environments/${{ env.ENVIRONMENT }}.bicepparam \
            --parameters sqlAdminLogin="$SQL_LOGIN" \
            --parameters sqlAdminPassword="$SQL_PASSWORD" \
            --parameters secretKey="$SECRET_KEY" \
            --parameters openaiApiKey="$OPENAI_API_KEY" \
            --name "newsmind-${{ env.ENVIRONMENT }}-$(date +%Y%m%d-%H%M%S)" \
            --query properties.outputs \
            --output json)

          echo "üì¶ Deployment outputs:"
          echo "$deployment_output" | jq .

          # Extract outputs for GitHub Actions
          api_hostname=$(echo "$deployment_output" | jq -r '.apiHostname.value // empty')
          keyvault_name=$(echo "$deployment_output" | jq -r '.keyVaultName.value // empty')

          # Set outputs for subsequent jobs
          echo "api_url=https://${api_hostname}" >> $GITHUB_OUTPUT
          echo "keyvault_name=${keyvault_name}" >> $GITHUB_OUTPUT

          echo ""
          echo "‚úÖ Deployment complete!"
          echo "   API URL: https://${api_hostname}"
          echo "   Key Vault: ${keyvault_name}"

      - name: Deployment Summary
        run: |
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ env.ENVIRONMENT }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | \`newsmind-${{ env.ENVIRONMENT }}-rg\` |" >> $GITHUB_STEP_SUMMARY
          echo "| API URL | ${{ steps.deploy.outputs.api_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Key Vault | \`${{ steps.deploy.outputs.keyvault_name }}\` |" >> $GITHUB_STEP_SUMMARY

  # --------------------------------------------------------------------------
  # Job 4: Build and Deploy Application
  # --------------------------------------------------------------------------
  build-and-deploy-app:
    name: Build & Deploy App
    runs-on: ubuntu-latest
    needs: deploy
    # Always evaluate, run only if infrastructure deployment succeeded
    if: ${{ always() && needs.deploy.result == 'success' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Get ACR details from the deployed infrastructure
      - name: Get Infrastructure Outputs
        id: infra
        run: |
          # Get the latest deployment outputs
          outputs=$(az deployment group show \
            --resource-group "newsmind-${{ env.ENVIRONMENT }}-rg" \
            --name "$(az deployment group list --resource-group newsmind-${{ env.ENVIRONMENT }}-rg --query '[0].name' -o tsv)" \
            --query properties.outputs \
            --output json 2>/dev/null || echo '{}')
          
          # Extract values
          acr_name=$(echo "$outputs" | jq -r '.acrName.value // empty')
          acr_login_server=$(echo "$outputs" | jq -r '.acrLoginServer.value // empty')
          
          # Fallback to constructed names if outputs not available
          if [ -z "$acr_name" ]; then
            acr_name="newsmind${{ env.ENVIRONMENT }}acr"
            acr_login_server="${acr_name}.azurecr.io"
          fi
          
          echo "acr_name=$acr_name" >> $GITHUB_OUTPUT
          echo "acr_login_server=$acr_login_server" >> $GITHUB_OUTPUT
          echo "image_tag=$acr_login_server/newsminds-api:${{ github.sha }}" >> $GITHUB_OUTPUT

      # Login to Azure Container Registry
      - name: Login to ACR
        run: az acr login --name ${{ steps.infra.outputs.acr_name }}

      # Get ACR credentials for Container App
      - name: Get ACR Credentials
        id: acr_creds
        run: |
          acr_username=$(az acr credential show --name ${{ steps.infra.outputs.acr_name }} --query username -o tsv)
          acr_password=$(az acr credential show --name ${{ steps.infra.outputs.acr_name }} --query "passwords[0].value" -o tsv)
          echo "::add-mask::$acr_password"
          echo "username=$acr_username" >> $GITHUB_OUTPUT
          echo "password=$acr_password" >> $GITHUB_OUTPUT

      # Build and push Docker image
      - name: Build and Push Docker Image
        run: |
          echo "üê≥ Building Docker image..."
          docker build -t ${{ steps.infra.outputs.image_tag }} .
          
          echo "üì§ Pushing to ACR..."
          docker push ${{ steps.infra.outputs.image_tag }}
          
          echo "‚úÖ Image pushed: ${{ steps.infra.outputs.image_tag }}"

      # Configure Container App to use ACR and deploy new image
      - name: Deploy to Container App
        run: |
          echo "üîß Configuring ACR registry for Container App..."

          # Configure the registry with admin credentials
          az containerapp registry set \
            --name "newsmind-${{ env.ENVIRONMENT }}-api" \
            --resource-group "newsmind-${{ env.ENVIRONMENT }}-rg" \
            --server ${{ steps.infra.outputs.acr_login_server }} \
            --username "${{ steps.acr_creds.outputs.username }}" \
            --password "${{ steps.acr_creds.outputs.password }}"

          echo "‚úÖ ACR registry configured"
          echo ""
          echo "üöÄ Deploying new image..."

          az containerapp update \
            --name "newsmind-${{ env.ENVIRONMENT }}-api" \
            --resource-group "newsmind-${{ env.ENVIRONMENT }}-rg" \
            --image ${{ steps.infra.outputs.image_tag }}

          echo "‚úÖ Deployment complete!"

      # Run database migrations
      - name: Install ODBC Driver
        run: |
          sudo rm -f /usr/share/keyrings/microsoft-prod.gpg
          curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | sudo gpg --batch --dearmor -o /usr/share/keyrings/microsoft-prod.gpg
          curl -fsSL https://packages.microsoft.com/config/ubuntu/24.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18 unixodbc-dev

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Run Database Migrations
        env:
          SQL_LOGIN: ${{ secrets.SQL_ADMIN_LOGIN }}
          SQL_PASSWORD: ${{ secrets.SQL_ADMIN_PASSWORD }}
        run: |
          echo "üóÑÔ∏è Running database migrations..."

          # Get the SQL server FQDN
          sql_fqdn=$(az sql server show \
            --name "newsmind-${{ env.ENVIRONMENT }}-sql" \
            --resource-group "newsmind-${{ env.ENVIRONMENT }}-rg" \
            --query fullyQualifiedDomainName \
            --output tsv)

          # Install Python dependencies for migrations
          # Note: bcrypt<5.0.0 is required for passlib compatibility
          pip install alembic sqlalchemy aioodbc pyodbc pydantic pydantic-settings "passlib[bcrypt]" "bcrypt<5.0.0"

          # Build the connection string for Alembic
          export DATABASE_URL="mssql+aioodbc://${SQL_LOGIN}:${SQL_PASSWORD}@${sql_fqdn}:1433/newsminds?driver=ODBC+Driver+18+for+SQL+Server&encrypt=yes&TrustServerCertificate=no"

          # Run migrations
          alembic upgrade head

          echo "‚úÖ Migrations complete!"

      - name: Deployment Summary
        run: |
          echo "## üê≥ Application Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ steps.infra.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Container App | \`newsmind-${{ env.ENVIRONMENT }}-api\` |" >> $GITHUB_STEP_SUMMARY
