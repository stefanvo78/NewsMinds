# ============================================================================
# Infrastructure Deployment Workflow
# ============================================================================
# Deploys Azure infrastructure using Bicep templates.
#
# Triggers:
# - Manual dispatch (workflow_dispatch) with environment selection
# - Push to main branch (deploys to dev)
#
# Authentication:
# Uses OIDC (Workload Identity Federation) - no secrets stored in GitHub!
# You need to set up an Azure AD App Registration with federated credentials.
#
# Required GitHub Secrets:
# - AZURE_CLIENT_ID: App registration client ID
# - AZURE_TENANT_ID: Azure AD tenant ID
# - AZURE_SUBSCRIPTION_ID: Azure subscription ID
# - POSTGRES_ADMIN_LOGIN: PostgreSQL admin username
# - POSTGRES_ADMIN_PASSWORD: PostgreSQL admin password
# ============================================================================

name: Deploy Infrastructure

on:
  # Manual trigger with environment selection
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      skip_what_if:
        description: 'Skip what-if preview (deploy immediately)'
        required: false
        default: false
        type: boolean

  # Auto-deploy dev on push to main
  push:
    branches: [main]
    paths:
      - 'infra/**'

# Permissions required for OIDC authentication
permissions:
  id-token: write   # Required for OIDC
  contents: read    # Required to checkout code

# Prevent concurrent deployments to the same environment
concurrency:
  group: deploy-${{ github.event.inputs.environment || 'dev' }}
  cancel-in-progress: false

env:
  # Default to 'dev' for push events, use input for manual triggers
  ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}

jobs:
  # --------------------------------------------------------------------------
  # Job 1: Validate templates before deployment
  # --------------------------------------------------------------------------
  validate:
    name: Validate Templates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Bicep
        run: az bicep build --file infra/main.bicep

  # --------------------------------------------------------------------------
  # Job 2: What-If Preview (shows what will change)
  # --------------------------------------------------------------------------
  what-if:
    name: Preview Changes
    runs-on: ubuntu-latest
    needs: validate
    # Skip if explicitly requested
    if: ${{ github.event.inputs.skip_what_if != 'true' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # OIDC authentication to Azure
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Ensure resource group exists
      - name: Create Resource Group (if needed)
        run: |
          az group create \
            --name "nminds-${{ env.ENVIRONMENT }}-rg" \
            --location "eastus2" \
            --tags Environment=${{ env.ENVIRONMENT }} Project=NewsMinds

      # What-If shows what would change without actually changing anything
      - name: What-If Preview
        env:
          POSTGRES_LOGIN: ${{ secrets.POSTGRES_ADMIN_LOGIN }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_ADMIN_PASSWORD }}
        run: |
          echo "ðŸ” Previewing changes for ${{ env.ENVIRONMENT }} environment..."
          echo ""

          az deployment group what-if \
            --resource-group "nminds-${{ env.ENVIRONMENT }}-rg" \
            --template-file infra/main.bicep \
            --parameters infra/environments/${{ env.ENVIRONMENT }}.bicepparam \
            --parameters postgresAdminLogin="$POSTGRES_LOGIN" \
            --parameters postgresAdminPassword="$POSTGRES_PASSWORD"

  # --------------------------------------------------------------------------
  # Job 3: Deploy Infrastructure
  # --------------------------------------------------------------------------
  deploy:
    name: Deploy to ${{ github.event.inputs.environment || 'dev' }}
    runs-on: ubuntu-latest
    needs: [validate, what-if]
    # Always run after validate, what-if may be skipped
    if: ${{ always() && needs.validate.result == 'success' && (needs.what-if.result == 'success' || needs.what-if.result == 'skipped') }}

    # Environment protection rules (optional - configure in GitHub settings)
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}
      url: ${{ steps.deploy.outputs.api_url }}

    outputs:
      api_url: ${{ steps.deploy.outputs.api_url }}
      keyvault_name: ${{ steps.deploy.outputs.keyvault_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create Resource Group
        run: |
          az group create \
            --name "nminds-${{ env.ENVIRONMENT }}-rg" \
            --location "eastus2" \
            --tags Environment=${{ env.ENVIRONMENT }} Project=NewsMinds ManagedBy=GitHubActions

      - name: Deploy Infrastructure
        id: deploy
        env:
          POSTGRES_LOGIN: ${{ secrets.POSTGRES_ADMIN_LOGIN }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_ADMIN_PASSWORD }}
        run: |
          echo "ðŸš€ Deploying to ${{ env.ENVIRONMENT }}..."
          echo ""

          # Deploy with Bicep
          deployment_output=$(az deployment group create \
            --resource-group "nminds-${{ env.ENVIRONMENT }}-rg" \
            --template-file infra/main.bicep \
            --parameters infra/environments/${{ env.ENVIRONMENT }}.bicepparam \
            --parameters postgresAdminLogin="$POSTGRES_LOGIN" \
            --parameters postgresAdminPassword="$POSTGRES_PASSWORD" \
            --name "nminds-${{ env.ENVIRONMENT }}-$(date +%Y%m%d-%H%M%S)" \
            --query properties.outputs \
            --output json)

          echo "ðŸ“¦ Deployment outputs:"
          echo "$deployment_output" | jq .

          # Extract outputs for GitHub Actions
          api_hostname=$(echo "$deployment_output" | jq -r '.apiHostname.value // empty')
          keyvault_name=$(echo "$deployment_output" | jq -r '.keyVaultName.value // empty')

          # Set outputs for subsequent jobs
          echo "api_url=https://${api_hostname}" >> $GITHUB_OUTPUT
          echo "keyvault_name=${keyvault_name}" >> $GITHUB_OUTPUT

          echo ""
          echo "âœ… Deployment complete!"
          echo "   API URL: https://${api_hostname}"
          echo "   Key Vault: ${keyvault_name}"

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ env.ENVIRONMENT }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | \`nminds-${{ env.ENVIRONMENT }}-rg\` |" >> $GITHUB_STEP_SUMMARY
          echo "| API URL | ${{ steps.deploy.outputs.api_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Key Vault | \`${{ steps.deploy.outputs.keyvault_name }}\` |" >> $GITHUB_STEP_SUMMARY
