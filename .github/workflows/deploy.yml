# ============================================================================
# Infrastructure Deployment Workflow
# ============================================================================
# Deploys Azure infrastructure using Bicep templates.
#
# Triggers:
# - Manual dispatch (workflow_dispatch) with environment selection
# - Push to main branch (deploys to dev)
#
# Authentication:
# Uses OIDC (Workload Identity Federation) - no secrets stored in GitHub!
# You need to set up an Azure AD App Registration with federated credentials.
#
# Required GitHub Secrets:
# - AZURE_CLIENT_ID: App registration client ID
# - AZURE_TENANT_ID: Azure AD tenant ID
# - AZURE_SUBSCRIPTION_ID: Azure subscription ID
# - SQL_ADMIN_LOGIN: SQL Server admin username
# - SQL_ADMIN_PASSWORD: SQL Server admin password
# - SECRET_KEY: JWT secret key for authentication
# ============================================================================

name: Deploy Infrastructure

on:
  # Manual trigger with environment selection
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      skip_what_if:
        description: 'Skip what-if preview (deploy immediately)'
        required: false
        default: false
        type: boolean

  # Auto-deploy dev on push to main
  push:
    branches: [main]
    paths:
      - 'infra/**'

# Permissions required for OIDC authentication
permissions:
  id-token: write   # Required for OIDC
  contents: read    # Required to checkout code

# Prevent concurrent deployments to the same environment
concurrency:
  group: deploy-${{ github.event.inputs.environment || 'dev' }}
  cancel-in-progress: false

env:
  # Default to 'dev' for push events, use input for manual triggers
  ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}

jobs:
  # --------------------------------------------------------------------------
  # Job 1: Validate templates before deployment
  # --------------------------------------------------------------------------
  validate:
    name: Validate Templates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Bicep
        run: az bicep build --file infra/main.bicep

  # --------------------------------------------------------------------------
  # Job 2: What-If Preview (shows what will change)
  # --------------------------------------------------------------------------
  what-if:
    name: Preview Changes
    runs-on: ubuntu-latest
    needs: validate
    # Skip if explicitly requested
    if: ${{ github.event.inputs.skip_what_if != 'true' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # OIDC authentication to Azure
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Ensure resource group exists
      - name: Create Resource Group (if needed)
        run: |
          az group create \
            --name "nminds-${{ env.ENVIRONMENT }}-rg" \
            --location "eastus2" \
            --tags Environment=${{ env.ENVIRONMENT }} Project=NewsMinds

      # What-If shows what would change without actually changing anything
      - name: What-If Preview
        env:
          SQL_LOGIN: ${{ secrets.SQL_ADMIN_LOGIN }}
          SQL_PASSWORD: ${{ secrets.SQL_ADMIN_PASSWORD }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        run: |
          echo "ðŸ” Previewing changes for ${{ env.ENVIRONMENT }} environment..."
          echo ""

          az deployment group what-if \
            --resource-group "nminds-${{ env.ENVIRONMENT }}-rg" \
            --template-file infra/main.bicep \
            --parameters infra/environments/${{ env.ENVIRONMENT }}.bicepparam \
            --parameters sqlAdminLogin="$SQL_LOGIN" \
            --parameters sqlAdminPassword="$SQL_PASSWORD" \
            --parameters secretKey="$SECRET_KEY"


  # --------------------------------------------------------------------------
  # Job 3: Deploy Infrastructure
  # --------------------------------------------------------------------------
  deploy:
    name: Deploy to ${{ github.event.inputs.environment || 'dev' }}
    runs-on: ubuntu-latest
    needs: [validate, what-if]
    # Always run after validate, what-if may be skipped
    if: ${{ always() && needs.validate.result == 'success' && (needs.what-if.result == 'success' || needs.what-if.result == 'skipped') }}

    # Environment protection rules (optional - configure in GitHub settings)
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}
      url: ${{ steps.deploy.outputs.api_url }}

    outputs:
      api_url: ${{ steps.deploy.outputs.api_url }}
      keyvault_name: ${{ steps.deploy.outputs.keyvault_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create Resource Group
        run: |
          az group create \
            --name "nminds-${{ env.ENVIRONMENT }}-rg" \
            --location "eastus2" \
            --tags Environment=${{ env.ENVIRONMENT }} Project=NewsMinds ManagedBy=GitHubActions

      - name: Deploy Infrastructure
        id: deploy
        env:
          SQL_LOGIN: ${{ secrets.SQL_ADMIN_LOGIN }}
          SQL_PASSWORD: ${{ secrets.SQL_ADMIN_PASSWORD }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        run: |
          echo "ðŸš€ Deploying to ${{ env.ENVIRONMENT }}..."
          echo ""

          # Deploy with Bicep
          deployment_output=$(az deployment group create \
            --resource-group "nminds-${{ env.ENVIRONMENT }}-rg" \
            --template-file infra/main.bicep \
            --parameters infra/environments/${{ env.ENVIRONMENT }}.bicepparam \
            --parameters sqlAdminLogin="$SQL_LOGIN" \
            --parameters sqlAdminPassword="$SQL_PASSWORD" \
            --parameters secretKey="$SECRET_KEY" \
            --name "nminds-${{ env.ENVIRONMENT }}-$(date +%Y%m%d-%H%M%S)" \
            --query properties.outputs \
            --output json)

          echo "ðŸ“¦ Deployment outputs:"
          echo "$deployment_output" | jq .

          # Extract outputs for GitHub Actions
          api_hostname=$(echo "$deployment_output" | jq -r '.apiHostname.value // empty')
          keyvault_name=$(echo "$deployment_output" | jq -r '.keyVaultName.value // empty')

          # Set outputs for subsequent jobs
          echo "api_url=https://${api_hostname}" >> $GITHUB_OUTPUT
          echo "keyvault_name=${keyvault_name}" >> $GITHUB_OUTPUT

          echo ""
          echo "âœ… Deployment complete!"
          echo "   API URL: https://${api_hostname}"
          echo "   Key Vault: ${keyvault_name}"

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ env.ENVIRONMENT }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | \`nminds-${{ env.ENVIRONMENT }}-rg\` |" >> $GITHUB_STEP_SUMMARY
          echo "| API URL | ${{ steps.deploy.outputs.api_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Key Vault | \`${{ steps.deploy.outputs.keyvault_name }}\` |" >> $GITHUB_STEP_SUMMARY

  # --------------------------------------------------------------------------
  # Job 4: Build and Deploy Application
  # --------------------------------------------------------------------------
  build-and-deploy-app:
    name: Build & Deploy App
    runs-on: ubuntu-latest
    needs: deploy
    # Only run if infrastructure deployment succeeded
    if: ${{ needs.deploy.result == 'success' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Get ACR details from the deployed infrastructure
      - name: Get Infrastructure Outputs
        id: infra
        run: |
          # Get the latest deployment outputs
          outputs=$(az deployment group show \
            --resource-group "nminds-${{ env.ENVIRONMENT }}-rg" \
            --name "$(az deployment group list --resource-group nminds-${{ env.ENVIRONMENT }}-rg --query '[0].name' -o tsv)" \
            --query properties.outputs \
            --output json 2>/dev/null || echo '{}')
          
          # Extract values
          acr_name=$(echo "$outputs" | jq -r '.acrName.value // empty')
          acr_login_server=$(echo "$outputs" | jq -r '.acrLoginServer.value // empty')
          
          # Fallback to constructed names if outputs not available
          if [ -z "$acr_name" ]; then
            acr_name="nminds${{ env.ENVIRONMENT }}acr"
            acr_login_server="${acr_name}.azurecr.io"
          fi
          
          echo "acr_name=$acr_name" >> $GITHUB_OUTPUT
          echo "acr_login_server=$acr_login_server" >> $GITHUB_OUTPUT
          echo "image_tag=$acr_login_server/newsminds-api:${{ github.sha }}" >> $GITHUB_OUTPUT

      # Login to Azure Container Registry
      - name: Login to ACR
        run: az acr login --name ${{ steps.infra.outputs.acr_name }}

      # Build and push Docker image
      - name: Build and Push Docker Image
        run: |
          echo "ðŸ³ Building Docker image..."
          docker build -t ${{ steps.infra.outputs.image_tag }} .
          
          echo "ðŸ“¤ Pushing to ACR..."
          docker push ${{ steps.infra.outputs.image_tag }}
          
          echo "âœ… Image pushed: ${{ steps.infra.outputs.image_tag }}"

      # Update Container App with new image
      - name: Deploy to Container App
        run: |
          echo "ðŸš€ Deploying to Container App..."
          
          az containerapp update \
            --name "nminds-${{ env.ENVIRONMENT }}-api" \
            --resource-group "nminds-${{ env.ENVIRONMENT }}-rg" \
            --image ${{ steps.infra.outputs.image_tag }} \
            --set-env-vars \
              "DATABASE_URL=secretref:database-url" \
              "SECRET_KEY=secretref:secret-key" \
              "DEBUG=false"
          
          echo "âœ… Deployment complete!"

      - name: Deployment Summary
        run: |
          echo "## ðŸ³ Application Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ steps.infra.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Container App | \`nminds-${{ env.ENVIRONMENT }}-api\` |" >> $GITHUB_STEP_SUMMARY
