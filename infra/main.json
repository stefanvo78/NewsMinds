{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "9814774760673140959"
    }
  },
  "parameters": {
    "environment": {
      "type": "string",
      "allowedValues": [
        "dev",
        "staging",
        "prod"
      ],
      "metadata": {
        "description": "Environment name (dev, staging, prod)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "westus2",
      "metadata": {
        "description": "Azure region for all resources"
      }
    },
    "projectName": {
      "type": "string",
      "defaultValue": "newsminds",
      "metadata": {
        "description": "Base name for all resources"
      }
    },
    "sqlAdminLogin": {
      "type": "securestring",
      "metadata": {
        "description": "SQL Server administrator login username"
      }
    },
    "sqlAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "SQL Server administrator password"
      }
    },
    "secretKey": {
      "type": "securestring",
      "metadata": {
        "description": "JWT secret key for authentication"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Tags to apply to all resources"
      }
    }
  },
  "variables": {
    "resourcePrefix": "[format('{0}-{1}', parameters('projectName'), parameters('environment'))]",
    "resourcePrefixNoHyphens": "[format('{0}{1}', parameters('projectName'), parameters('environment'))]",
    "defaultTags": {
      "Project": "[parameters('projectName')]",
      "Environment": "[parameters('environment')]",
      "ManagedBy": "Bicep",
      "Repository": "github.com/yourusername/NewsMinds"
    },
    "allTags": "[union(variables('defaultTags'), parameters('tags'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "keyVault-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}kv', variables('resourcePrefixNoHyphens'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('allTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "396639885224159503"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "minLength": 3,
              "maxLength": 24,
              "metadata": {
                "description": "Name of the Key Vault (3-24 chars, alphanumeric and hyphens)"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for the Key Vault"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the resource"
              }
            },
            "enableSoftDelete": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable soft delete (recommended for production)"
              }
            },
            "softDeleteRetentionInDays": {
              "type": "int",
              "defaultValue": 7,
              "minValue": 7,
              "maxValue": 90,
              "metadata": {
                "description": "Soft delete retention in days (7-90)"
              }
            },
            "enablePurgeProtection": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable purge protection (prevents permanent deletion)"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "tenantId": "[subscription().tenantId]",
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "enableRbacAuthorization": true,
                "enableSoftDelete": "[parameters('enableSoftDelete')]",
                "softDeleteRetentionInDays": "[parameters('softDeleteRetentionInDays')]",
                "enablePurgeProtection": "[if(parameters('enablePurgeProtection'), true(), null())]",
                "networkAcls": {
                  "defaultAction": "Allow",
                  "bypass": "AzureServices"
                }
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "metadata": {
                "description": "The Key Vault resource ID"
              },
              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "The Key Vault name"
              },
              "value": "[parameters('name')]"
            },
            "uri": {
              "type": "string",
              "metadata": {
                "description": "The Key Vault URI (https://{name}.vault.azure.net/)"
              },
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('name')), '2023-07-01').vaultUri]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "containerRegistry-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}acr', variables('resourcePrefixNoHyphens'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('allTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "3582714013788642094"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "minLength": 5,
              "maxLength": 50,
              "metadata": {
                "description": "Name of the Container Registry (must be globally unique, alphanumeric only)"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Basic",
              "allowedValues": [
                "Basic",
                "Standard",
                "Premium"
              ],
              "metadata": {
                "description": "SKU tier"
              }
            },
            "adminUserEnabled": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable admin user for password-based authentication"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-07-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('sku')]"
              },
              "properties": {
                "adminUserEnabled": "[parameters('adminUserEnabled')]",
                "publicNetworkAccess": "Enabled",
                "policies": {
                  "quarantinePolicy": {
                    "status": "disabled"
                  },
                  "retentionPolicy": {
                    "status": "disabled"
                  }
                }
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "metadata": {
                "description": "Container Registry resource ID"
              },
              "value": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Container Registry name"
              },
              "value": "[parameters('name')]"
            },
            "loginServer": {
              "type": "string",
              "metadata": {
                "description": "Container Registry login server (e.g., myregistry.azurecr.io)"
              },
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('name')), '2023-07-01').loginServer]"
            },
            "adminUsername": {
              "type": "string",
              "metadata": {
                "description": "Admin username (if admin user is enabled)"
              },
              "value": "[if(parameters('adminUserEnabled'), listCredentials(resourceId('Microsoft.ContainerRegistry/registries', parameters('name')), '2023-07-01').username, '')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "logAnalytics-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}-logs', variables('resourcePrefix'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('allTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "3053241508936453752"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Log Analytics Workspace"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for the workspace"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the resource"
              }
            },
            "retentionInDays": {
              "type": "int",
              "defaultValue": 30,
              "minValue": 30,
              "maxValue": 730,
              "metadata": {
                "description": "Log retention period in days (30-730)"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "PerGB2018",
              "allowedValues": [
                "Free",
                "PerGB2018",
                "PerNode",
                "Premium",
                "Standalone",
                "Standard"
              ],
              "metadata": {
                "description": "SKU for the workspace"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "retentionInDays": "[parameters('retentionInDays')]",
                "sku": {
                  "name": "[parameters('sku')]"
                },
                "features": {
                  "searchVersion": 1,
                  "enableLogAccessUsingOnlyResourcePermissions": true
                }
              }
            }
          ],
          "outputs": {
            "workspaceId": {
              "type": "string",
              "metadata": {
                "description": "The workspace resource ID"
              },
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "The workspace name"
              },
              "value": "[parameters('name')]"
            },
            "customerId": {
              "type": "string",
              "metadata": {
                "description": "The workspace customer ID (used for agent configuration)"
              },
              "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('name')), '2023-09-01').customerId]"
            },
            "primarySharedKey": {
              "type": "string",
              "metadata": {
                "description": "The primary shared key (for agent authentication)"
              },
              "value": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', parameters('name')), '2023-09-01').primarySharedKey]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "appInsights-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}-insights', variables('resourcePrefix'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('allTags')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logAnalytics-deployment'), '2025-04-01').outputs.workspaceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "15086575231864180146"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Application Insights resource"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the resource"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace ID for backend storage"
              }
            },
            "applicationType": {
              "type": "string",
              "defaultValue": "web",
              "allowedValues": [
                "web",
                "other"
              ],
              "metadata": {
                "description": "Application type"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "web",
              "properties": {
                "Application_Type": "[parameters('applicationType')]",
                "Flow_Type": "Bluefield",
                "Request_Source": "IbizaAIExtension",
                "WorkspaceResourceId": "[parameters('logAnalyticsWorkspaceId')]",
                "IngestionMode": "LogAnalytics",
                "DisableIpMasking": false,
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "metadata": {
                "description": "Application Insights resource ID"
              },
              "value": "[resourceId('Microsoft.Insights/components', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Application Insights name"
              },
              "value": "[parameters('name')]"
            },
            "instrumentationKey": {
              "type": "string",
              "metadata": {
                "description": "Instrumentation Key (legacy, but still used by some SDKs)"
              },
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('name')), '2020-02-02').InstrumentationKey]"
            },
            "connectionString": {
              "type": "string",
              "metadata": {
                "description": "Connection String (preferred method for SDK configuration)"
              },
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('name')), '2020-02-02').ConnectionString]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'logAnalytics-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "sqlDatabase-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "serverName": {
            "value": "[format('{0}-sql', variables('resourcePrefix'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('allTags')]"
          },
          "administratorLogin": {
            "value": "[parameters('sqlAdminLogin')]"
          },
          "administratorPassword": {
            "value": "[parameters('sqlAdminPassword')]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyVault-deployment'), '2025-04-01').outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "1946848280828333296"
            }
          },
          "parameters": {
            "serverName": {
              "type": "string",
              "metadata": {
                "description": "SQL Server name (globally unique)"
              }
            },
            "databaseName": {
              "type": "string",
              "defaultValue": "newsminds",
              "metadata": {
                "description": "Database name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "administratorLogin": {
              "type": "securestring",
              "metadata": {
                "description": "Administrator login username"
              }
            },
            "administratorPassword": {
              "type": "securestring",
              "metadata": {
                "description": "Administrator login password"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name for storing connection string"
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "GP_S_Gen5_1",
              "allowedValues": [
                "Basic",
                "S0",
                "S1",
                "GP_S_Gen5_1",
                "GP_S_Gen5_2"
              ],
              "metadata": {
                "description": "SKU name for the database"
              }
            },
            "autoPauseDelay": {
              "type": "int",
              "defaultValue": 60,
              "minValue": 60,
              "maxValue": 10080,
              "metadata": {
                "description": "Enable serverless auto-pause (minutes of inactivity)"
              }
            },
            "minCapacity": {
              "type": "string",
              "defaultValue": "0.5",
              "metadata": {
                "description": "Minimum capacity (vCores) for serverless"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Sql/servers",
              "apiVersion": "2023-08-01-preview",
              "name": "[parameters('serverName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "administratorLogin": "[parameters('administratorLogin')]",
                "administratorLoginPassword": "[parameters('administratorPassword')]",
                "version": "12.0",
                "minimalTlsVersion": "1.2",
                "publicNetworkAccess": "Enabled"
              }
            },
            {
              "type": "Microsoft.Sql/servers/firewallRules",
              "apiVersion": "2023-08-01-preview",
              "name": "[format('{0}/{1}', parameters('serverName'), 'AllowAllAzureIps')]",
              "properties": {
                "startIpAddress": "0.0.0.0",
                "endIpAddress": "0.0.0.0"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', parameters('serverName'))]"
              ]
            },
            {
              "type": "Microsoft.Sql/servers/databases",
              "apiVersion": "2023-08-01-preview",
              "name": "[format('{0}/{1}', parameters('serverName'), parameters('databaseName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('skuName')]",
                "tier": "[if(equals(parameters('skuName'), 'Basic'), 'Basic', if(startsWith(parameters('skuName'), 'S'), 'Standard', 'GeneralPurpose'))]"
              },
              "properties": {
                "collation": "SQL_Latin1_General_CP1_CI_AS",
                "maxSizeBytes": "[if(equals(parameters('skuName'), 'Basic'), json('2147483648'), json('34359738368'))]",
                "autoPauseDelay": "[if(startsWith(parameters('skuName'), 'GP_S'), parameters('autoPauseDelay'), -1)]",
                "minCapacity": "[if(startsWith(parameters('skuName'), 'GP_S'), json(parameters('minCapacity')), null())]",
                "requestedBackupStorageRedundancy": "Local"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', parameters('serverName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'sql-connection-string')]",
              "properties": {
                "value": "[format('Driver={{ODBC Driver 18 for SQL Server}};Server=tcp:{0},1433;Database={1};Uid={2};Pwd={3};Encrypt=yes;TrustServerCertificate=no;Connection Timeout=30;', reference(resourceId('Microsoft.Sql/servers', parameters('serverName')), '2023-08-01-preview').fullyQualifiedDomainName, parameters('databaseName'), parameters('administratorLogin'), parameters('administratorPassword'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', parameters('serverName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'sqlalchemy-connection-string')]",
              "properties": {
                "value": "[format('mssql+aioodbc://{0}:{1}@{2}:1433/{3}?driver=ODBC+Driver+18+for+SQL+Server&encrypt=yes&TrustServerCertificate=no', parameters('administratorLogin'), parameters('administratorPassword'), reference(resourceId('Microsoft.Sql/servers', parameters('serverName')), '2023-08-01-preview').fullyQualifiedDomainName, parameters('databaseName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', parameters('serverName'))]"
              ]
            }
          ],
          "outputs": {
            "serverId": {
              "type": "string",
              "metadata": {
                "description": "SQL Server resource ID"
              },
              "value": "[resourceId('Microsoft.Sql/servers', parameters('serverName'))]"
            },
            "serverName": {
              "type": "string",
              "metadata": {
                "description": "SQL Server name"
              },
              "value": "[parameters('serverName')]"
            },
            "fqdn": {
              "type": "string",
              "metadata": {
                "description": "SQL Server FQDN"
              },
              "value": "[reference(resourceId('Microsoft.Sql/servers', parameters('serverName')), '2023-08-01-preview').fullyQualifiedDomainName]"
            },
            "databaseName": {
              "type": "string",
              "metadata": {
                "description": "Database name"
              },
              "value": "[parameters('databaseName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'keyVault-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "redis-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}-redis', variables('resourcePrefix'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('allTags')]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyVault-deployment'), '2025-04-01').outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "4025827356803606977"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Redis Cache instance"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for the cache"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the resource"
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "Basic",
              "allowedValues": [
                "Basic",
                "Standard",
                "Premium"
              ],
              "metadata": {
                "description": "SKU: Basic (dev), Standard (HA), Premium (clustering)"
              }
            },
            "skuFamily": {
              "type": "string",
              "defaultValue": "C",
              "allowedValues": [
                "C",
                "P"
              ],
              "metadata": {
                "description": "SKU Family: C (Basic/Standard), P (Premium)"
              }
            },
            "skuCapacity": {
              "type": "int",
              "defaultValue": 0,
              "minValue": 0,
              "maxValue": 6,
              "metadata": {
                "description": "Cache size: 0=250MB, 1=1GB, 2=2.5GB, etc."
              }
            },
            "enableNonSslPort": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable non-SSL port (6379). Disable for production."
              }
            },
            "minimumTlsVersion": {
              "type": "string",
              "defaultValue": "1.2",
              "allowedValues": [
                "1.0",
                "1.1",
                "1.2"
              ],
              "metadata": {
                "description": "Minimum TLS version"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Key Vault to store connection string"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Cache/redis",
              "apiVersion": "2023-08-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "[parameters('skuName')]",
                  "family": "[parameters('skuFamily')]",
                  "capacity": "[parameters('skuCapacity')]"
                },
                "enableNonSslPort": "[parameters('enableNonSslPort')]",
                "minimumTlsVersion": "[parameters('minimumTlsVersion')]",
                "redisConfiguration": {
                  "maxmemory-policy": "volatile-lru"
                },
                "publicNetworkAccess": "Enabled"
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'RedisConnectionString')]",
              "properties": {
                "value": "[format('rediss://:{0}@{1}:{2}', listKeys(resourceId('Microsoft.Cache/redis', parameters('name')), '2023-08-01').primaryKey, reference(resourceId('Microsoft.Cache/redis', parameters('name')), '2023-08-01').hostName, reference(resourceId('Microsoft.Cache/redis', parameters('name')), '2023-08-01').sslPort)]",
                "contentType": "text/plain",
                "attributes": {
                  "enabled": true
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Cache/redis', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'RedisPrimaryKey')]",
              "properties": {
                "value": "[listKeys(resourceId('Microsoft.Cache/redis', parameters('name')), '2023-08-01').primaryKey]",
                "contentType": "text/plain",
                "attributes": {
                  "enabled": true
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Cache/redis', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "metadata": {
                "description": "Redis Cache resource ID"
              },
              "value": "[resourceId('Microsoft.Cache/redis', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Redis Cache name"
              },
              "value": "[parameters('name')]"
            },
            "hostname": {
              "type": "string",
              "metadata": {
                "description": "Redis Cache hostname"
              },
              "value": "[reference(resourceId('Microsoft.Cache/redis', parameters('name')), '2023-08-01').hostName]"
            },
            "sslPort": {
              "type": "int",
              "metadata": {
                "description": "Redis SSL port (6380)"
              },
              "value": "[reference(resourceId('Microsoft.Cache/redis', parameters('name')), '2023-08-01').sslPort]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'keyVault-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "containerAppsEnv-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}-cae', variables('resourcePrefix'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('allTags')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logAnalytics-deployment'), '2025-04-01').outputs.workspaceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "105842677036211507"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container Apps Environment"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace ID for logging"
              }
            },
            "zoneRedundant": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable zone redundancy (for production high availability)"
              }
            },
            "workloadProfileType": {
              "type": "string",
              "defaultValue": "Consumption",
              "allowedValues": [
                "Consumption",
                "D4",
                "D8",
                "D16",
                "D32",
                "E4",
                "E8",
                "E16",
                "E32"
              ],
              "metadata": {
                "description": "Workload profile type"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2024-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "appLogsConfiguration": {
                  "destination": "log-analytics",
                  "logAnalyticsConfiguration": {
                    "customerId": "[reference(parameters('logAnalyticsWorkspaceId'), '2023-09-01').customerId]",
                    "sharedKey": "[listKeys(parameters('logAnalyticsWorkspaceId'), '2023-09-01').primarySharedKey]"
                  }
                },
                "zoneRedundant": "[parameters('zoneRedundant')]",
                "workloadProfiles": [
                  {
                    "name": "Consumption",
                    "workloadProfileType": "Consumption"
                  }
                ],
                "peerAuthentication": {
                  "mtls": {
                    "enabled": true
                  }
                }
              }
            },
            {
              "type": "Microsoft.App/managedEnvironments/daprComponents",
              "apiVersion": "2024-03-01",
              "name": "[format('{0}/{1}', parameters('name'), 'pubsub-redis')]",
              "properties": {
                "componentType": "pubsub.redis",
                "version": "v1",
                "metadata": [
                  {
                    "name": "redisHost",
                    "value": "placeholder-to-be-set"
                  },
                  {
                    "name": "redisPassword",
                    "secretRef": "redis-password"
                  },
                  {
                    "name": "enableTLS",
                    "value": "true"
                  }
                ],
                "secrets": [
                  {
                    "name": "redis-password",
                    "value": "placeholder-to-be-set"
                  }
                ],
                "scopes": [
                  "collector-agent",
                  "analyzer-agent",
                  "synthesizer-agent"
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.App/managedEnvironments', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.App/managedEnvironments/daprComponents",
              "apiVersion": "2024-03-01",
              "name": "[format('{0}/{1}', parameters('name'), 'statestore-redis')]",
              "properties": {
                "componentType": "state.redis",
                "version": "v1",
                "metadata": [
                  {
                    "name": "redisHost",
                    "value": "placeholder-to-be-set"
                  },
                  {
                    "name": "redisPassword",
                    "secretRef": "redis-password"
                  },
                  {
                    "name": "enableTLS",
                    "value": "true"
                  },
                  {
                    "name": "actorStateStore",
                    "value": "true"
                  }
                ],
                "secrets": [
                  {
                    "name": "redis-password",
                    "value": "placeholder-to-be-set"
                  }
                ],
                "scopes": [
                  "collector-agent",
                  "analyzer-agent",
                  "synthesizer-agent"
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.App/managedEnvironments', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "metadata": {
                "description": "Container Apps Environment ID"
              },
              "value": "[resourceId('Microsoft.App/managedEnvironments', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Container Apps Environment name"
              },
              "value": "[parameters('name')]"
            },
            "defaultDomain": {
              "type": "string",
              "metadata": {
                "description": "Default domain for container apps"
              },
              "value": "[reference(resourceId('Microsoft.App/managedEnvironments', parameters('name')), '2024-03-01').defaultDomain]"
            },
            "staticIp": {
              "type": "string",
              "metadata": {
                "description": "Static IP for the environment (if applicable)"
              },
              "value": "[reference(resourceId('Microsoft.App/managedEnvironments', parameters('name')), '2024-03-01').staticIp]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'logAnalytics-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "apiContainerApp-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}-api', variables('resourcePrefix'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('allTags')]"
          },
          "containerAppsEnvId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'containerAppsEnv-deployment'), '2025-04-01').outputs.id.value]"
          },
          "appInsightsConnectionString": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appInsights-deployment'), '2025-04-01').outputs.connectionString.value]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyVault-deployment'), '2025-04-01').outputs.name.value]"
          },
          "acrLoginServer": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'containerRegistry-deployment'), '2025-04-01').outputs.loginServer.value]"
          },
          "acrName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'containerRegistry-deployment'), '2025-04-01').outputs.name.value]"
          },
          "databaseUrl": {
            "value": "[format('mssql+aioodbc://{0}:{1}@{2}:1433/newsminds?driver=ODBC+Driver+18+for+SQL+Server&encrypt=yes&TrustServerCertificate=no', parameters('sqlAdminLogin'), parameters('sqlAdminPassword'), reference(resourceId('Microsoft.Resources/deployments', 'sqlDatabase-deployment'), '2025-04-01').outputs.fqdn.value)]"
          },
          "secretKey": {
            "value": "[parameters('secretKey')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "1047039187418158842"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container App"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "containerAppsEnvId": {
              "type": "string",
              "metadata": {
                "description": "Container Apps Environment ID"
              }
            },
            "appInsightsConnectionString": {
              "type": "string",
              "metadata": {
                "description": "Application Insights connection string"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name for secret references"
              }
            },
            "acrLoginServer": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Container Registry login server (e.g., myregistry.azurecr.io)"
              }
            },
            "acrName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Container Registry name for managed identity access"
              }
            },
            "containerImage": {
              "type": "string",
              "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
              "metadata": {
                "description": "Container image to deploy (defaults to placeholder if not provided)"
              }
            },
            "databaseUrl": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "Database connection string (for Azure SQL)"
              }
            },
            "secretKey": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "JWT secret key"
              }
            },
            "minReplicas": {
              "type": "int",
              "defaultValue": 0,
              "minValue": 0,
              "maxValue": 30,
              "metadata": {
                "description": "Minimum number of replicas"
              }
            },
            "maxReplicas": {
              "type": "int",
              "defaultValue": 3,
              "minValue": 1,
              "maxValue": 30,
              "metadata": {
                "description": "Maximum number of replicas"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "managedEnvironmentId": "[parameters('containerAppsEnvId')]",
                "configuration": {
                  "ingress": {
                    "external": true,
                    "targetPort": 8000,
                    "transport": "http",
                    "allowInsecure": false,
                    "traffic": [
                      {
                        "latestRevision": true,
                        "weight": 100
                      }
                    ]
                  },
                  "secrets": [
                    {
                      "name": "appinsights-connection-string",
                      "value": "[parameters('appInsightsConnectionString')]"
                    },
                    {
                      "name": "database-url",
                      "value": "[parameters('databaseUrl')]"
                    },
                    {
                      "name": "secret-key",
                      "value": "[parameters('secretKey')]"
                    }
                  ],
                  "registries": "[if(not(equals(parameters('acrLoginServer'), '')), createArray(createObject('server', parameters('acrLoginServer'), 'identity', 'system')), createArray())]"
                },
                "template": {
                  "containers": [
                    {
                      "name": "api",
                      "image": "[parameters('containerImage')]",
                      "resources": {
                        "cpu": "[json('0.5')]",
                        "memory": "1Gi"
                      },
                      "env": [
                        {
                          "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                          "secretRef": "appinsights-connection-string"
                        },
                        {
                          "name": "KEY_VAULT_URL",
                          "value": "[format('https://{0}{1}/', parameters('keyVaultName'), environment().suffixes.keyvaultDns)]"
                        },
                        {
                          "name": "ENVIRONMENT",
                          "value": "[if(contains(parameters('name'), 'prod'), 'production', 'development')]"
                        },
                        {
                          "name": "PORT",
                          "value": "8000"
                        },
                        {
                          "name": "DATABASE_URL",
                          "secretRef": "database-url"
                        },
                        {
                          "name": "SECRET_KEY",
                          "secretRef": "secret-key"
                        },
                        {
                          "name": "DEBUG",
                          "value": "false"
                        }
                      ],
                      "probes": [
                        {
                          "type": "Liveness",
                          "httpGet": {
                            "path": "/health",
                            "port": 8000
                          },
                          "initialDelaySeconds": 10,
                          "periodSeconds": 30
                        },
                        {
                          "type": "Readiness",
                          "httpGet": {
                            "path": "/health",
                            "port": 8000
                          },
                          "initialDelaySeconds": 5,
                          "periodSeconds": 10
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": "[parameters('minReplicas')]",
                    "maxReplicas": "[parameters('maxReplicas')]",
                    "rules": [
                      {
                        "name": "http-scaling",
                        "http": {
                          "metadata": {
                            "concurrentRequests": "100"
                          }
                        }
                      }
                    ]
                  }
                }
              }
            },
            {
              "condition": "[not(equals(parameters('acrName'), ''))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(resourceGroup().id, parameters('name'), parameters('acrName'), 'acrpull')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]",
                "principalId": "[reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.App/containerApps', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "metadata": {
                "description": "Container App resource ID"
              },
              "value": "[resourceId('Microsoft.App/containerApps', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Container App name"
              },
              "value": "[parameters('name')]"
            },
            "fqdn": {
              "type": "string",
              "metadata": {
                "description": "Container App FQDN (fully qualified domain name)"
              },
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').configuration.ingress.fqdn]"
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Container App principal ID (for RBAC)"
              },
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appInsights-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'containerAppsEnv-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'containerRegistry-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'keyVault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'sqlDatabase-deployment')]"
      ]
    }
  ],
  "outputs": {
    "keyVaultName": {
      "type": "string",
      "metadata": {
        "description": "Key Vault name for secret management"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyVault-deployment'), '2025-04-01').outputs.name.value]"
    },
    "keyVaultUri": {
      "type": "string",
      "metadata": {
        "description": "Key Vault URI for SDK configuration"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyVault-deployment'), '2025-04-01').outputs.uri.value]"
    },
    "appInsightsConnectionString": {
      "type": "string",
      "metadata": {
        "description": "Application Insights connection string"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appInsights-deployment'), '2025-04-01').outputs.connectionString.value]"
    },
    "sqlServerFqdn": {
      "type": "string",
      "metadata": {
        "description": "SQL Server FQDN"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'sqlDatabase-deployment'), '2025-04-01').outputs.fqdn.value]"
    },
    "redisHostname": {
      "type": "string",
      "metadata": {
        "description": "Redis hostname"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'redis-deployment'), '2025-04-01').outputs.hostname.value]"
    },
    "containerAppsEnvId": {
      "type": "string",
      "metadata": {
        "description": "Container Apps Environment ID"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'containerAppsEnv-deployment'), '2025-04-01').outputs.id.value]"
    },
    "apiHostname": {
      "type": "string",
      "metadata": {
        "description": "API Container App FQDN"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'apiContainerApp-deployment'), '2025-04-01').outputs.fqdn.value]"
    },
    "acrLoginServer": {
      "type": "string",
      "metadata": {
        "description": "Container Registry login server"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'containerRegistry-deployment'), '2025-04-01').outputs.loginServer.value]"
    },
    "acrName": {
      "type": "string",
      "metadata": {
        "description": "Container Registry name"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'containerRegistry-deployment'), '2025-04-01').outputs.name.value]"
    }
  }
}